name: Branch Cleanup

on:
  pull_request:
    types: [closed]
    branches: [main]
  schedule:
    # 毎日午前3時 (UTC) = 正午 (JST) にstaleブランチをチェック
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  cleanup-on-close:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    
    steps:
      - name: Delete branch after PR closed
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.payload.pull_request.head.ref;
            const merged = context.payload.pull_request.merged;
            const protectedBranches = ['main', 'develop'];
            
            if (protectedBranches.includes(branch)) {
              console.log(`Branch '${branch}' is protected. Skipping deletion.`);
              return;
            }
            
            // Dependabotブランチとdev/ブランチはマージ時に削除
            // その他のブランチはマージ時のみ削除
            const isDependabot = branch.startsWith('dependabot/');
            const isDevBranch = branch.startsWith('dev/');
            
            if (!merged && !isDependabot) {
              console.log(`Branch '${branch}' was not merged. Skipping deletion (not a dependabot branch).`);
              return;
            }
            
            // dev/ブランチはマージ時のみ削除
            if (isDevBranch && !merged) {
              console.log(`Branch '${branch}' was not merged. Skipping deletion.`);
              return;
            }
            
            try {
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${branch}`
              });
              console.log(`Branch '${branch}' deleted successfully. (merged: ${merged})`);
            } catch (error) {
              console.log(`Failed to delete branch '${branch}': ${error.message}`);
            }


  cleanup-stale:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
      - name: Delete stale Dependabot branches
        uses: actions/github-script@v7
        with:
          script: |
            const protectedBranches = ['main', 'develop'];
            const staleDays = 7; // 7日以上古いブランチを削除
            const now = new Date();
            
            // 全ブランチを取得
            const { data: branches } = await github.rest.repos.listBranches({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            for (const branch of branches) {
              const branchName = branch.name;
              
              // 保護ブランチはスキップ
              if (protectedBranches.includes(branchName)) {
                continue;
              }
              
              // Dependabotブランチのみ対象
              if (!branchName.startsWith('dependabot/')) {
                continue;
              }
              
              // ブランチの最終コミット日時を取得
              const { data: commit } = await github.rest.repos.getCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: branchName
              });
              
              const commitDate = new Date(commit.commit.committer.date);
              const daysSinceCommit = (now - commitDate) / (1000 * 60 * 60 * 24);
              
              if (daysSinceCommit > staleDays) {
                try {
                  await github.rest.git.deleteRef({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    ref: `heads/${branchName}`
                  });
                  console.log(`Deleted stale branch '${branchName}' (${Math.floor(daysSinceCommit)} days old)`);
                } catch (error) {
                  console.log(`Failed to delete '${branchName}': ${error.message}`);
                }
              } else {
                console.log(`Branch '${branchName}' is ${Math.floor(daysSinceCommit)} days old, keeping for now.`);
              }
            }

