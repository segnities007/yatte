# ユースケース仕様

プロジェクトの主要なユースケースとフロー定義。

## 1. タスク管理

### UC-01: タスクを作成する

- **Actor**: ユーザー
- **Precondition**: なし
- **Postcondition**: タスクが保存され、アラームがスケジュールされる

**Main Flow**:
1. ユーザーは「タスク作成」画面を開く
2. タイトル、時刻等を入力し「保存」ボタンを押下
3. システムは入力値を検証する
4. システムはタスクをDBに保存する
5. システムは次回のアラーム日時を計算し、OSのアラームをセットする
6. 画面を閉じ、トーストを表示する

**Alternative Flow (バリデーションエラー)**:
3a. 入力値が不正（タイトル空など）
3b. エラーメッセージを表示し、保存を中断する

### UC-02: タスクを完了する

- **Actor**: ユーザー
- **Precondition**: タスクが存在する

**Main Flow**:
1. ユーザーはタスクのチェックボックスをタップする
2. システムは完了音を鳴らす（設定ONの場合）
3. システムはタスクの `completedDates` に今日を追加する
4. システムは `History` を作成し保存する
5. 1回きりタスクの場合、次回アラームをキャンセルする

---

## 2. アラーム処理

### UC-11: アラーム通知を受信する

- **Actor**: システム（OS）
- **Trigger**: 設定された通知時刻になる

**Main Flow**:
1. OSは `AlarmReceiver` を起動する
2. システムは通知（Notification）を表示する
3. システムは `Alarm` を発火済み (`isTriggered = true`) に更新する
4. （1回きりタスクの場合）システムは `Task.alarmTriggeredAt` を更新し、24時間カウントダウンを開始する

**Alternative Flow (ユーザーアクション)**:
2a. ユーザーが通知の「10分延長」ボタンを押下
    1. システムは現在のアラームをキャンセルする
    2. システムは `now + 10分` で新しいアラームを設定する
    3. システムは通知を閉じる
2b. ユーザーが通知の「完了」ボタンを押下
    1. [UC-02: タスクを完了する] を実行する
    2. システムは通知を閉じる

### UC-12: タスクを自動削除する (Cleanup)

- **Actor**: システム（バックグラウンドワーカー）
- **Trigger**: 定期実行（またはアプリ起動時）

**Main Flow**:
1. システムは全ての `ONE_TIME` タスクをスキャンする
2. `shouldBeDeleted(now)` が true のタスクを抽出する
3. 対象タスクを `EXPIRED` ステータスで履歴に保存する
4. 対象タスクをDBから削除する
5. 削除数をログに出力する

---

## 3. 履歴管理

### UC-21: 履歴を確認する

- **Actor**: ユーザー

**Main Flow**:
1. ユーザーは「履歴」タブを開く
2. システムは完了履歴を時系列で取得する
3. 今日の完了数をヘッダーに表示する
4. タイムラインリストを表示する

### UC-22: 履歴をエクスポートする

- **Actor**: ユーザー

**Main Flow**:
1. ユーザーは履歴画面のメニューから「エクスポート」を選択する
2. 形式（CSV/JSON）を選択する
3. システムは全履歴を取得しフォーマットする
4. 共有シートを表示し、外部アプリへ渡す

---

## 4. 設定管理

### UC-31: データを全削除する

- **Actor**: ユーザー

**Main Flow**:
1. ユーザーは設定画面で「データ削除」をタップする
2. 警告ダイアログが表示される
3. ユーザーが「削除」を確認する
4. システムは Task, History, Alarm の全テーブルをTRUNCATEする
5. システムはセットされている全OSアラームをキャンセルする
6. 完了メッセージを表示する

---

## 5. カテゴリ管理

### UC-41: カテゴリを作成する

- **Actor**: ユーザー

**Main Flow**:
1. ユーザーは設定画面またはタスク作成画面から「カテゴリ管理」を開く
2. 「追加」ボタンをタップする
3. 名前を入力し、色を選択する
4. 「保存」をタップする
5. システムはカテゴリを保存し、リストに追加する

### UC-42: カテゴリを編集する

- **Actor**: ユーザー

**Main Flow**:
1. ユーザーはカテゴリリストから対象カテゴリをタップする
2. 名前または色を変更する
3. 「保存」をタップする
4. システムは更新を保存する

### UC-43: カテゴリを削除する

- **Actor**: ユーザー

**Main Flow**:
1. ユーザーはカテゴリをスワイプ（または削除アイコンをタップ）する
2. 確認ダイアログが表示される
3. ユーザーが承認する
4. システムはカテゴリを削除する
   - 紐付いていたタスクの `categoryId` は `null` になる

---

*作成日: 2025-12-27*
